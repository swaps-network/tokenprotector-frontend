<div class="base-block-content">
  <div class="app-content-block">

    <!-- Mobile step counts -->
    <div class="grid-row steps-mobile">

      <div class="grid-cell grid-cell-1-4">
        <div class="steps-mobile_item"
             (click)="stepper.current = (!previewTrigger && editableTokenProtector) ? 0 : stepper.current"
             [ngClass]="{
                'checked': (addressForm.valid) && (stepper.current > 0),
                'active': editableTokenProtector && (stepper.current === 0),
                'opened': stepper.current === 0
             }"></div>
      </div>
      <div class="grid-cell grid-cell-1-4">
        <div class="steps-mobile_item"
             (click)="stepper.current = (!previewTrigger && addressForm.valid && editableTokenProtector && (stepper.current >= 1)) ? 1 : stepper.current;"
             [ngClass]="{
                'active': addressForm.valid && editableTokenProtector && (stepper.current === 1),
                'checked': conditionsForm.valid && (stepper.current > 1),
                'opened': stepper.current === 1
             }"></div>
      </div>
      <div class="grid-cell grid-cell-1-4">
        <div class="steps-mobile_item"
             (click)="stepper.current = (!previewTrigger && addressForm.valid && editableTokenProtector && (stepper.current >= 2)) ? 2 : stepper.current;"
             [ngClass]="{
                'active': addressForm.valid && conditionsForm.valid && editableTokenProtector && (stepper.current === 2),
                'checked': stepper.current > 2,
                'opened': stepper.current === 2
             }"></div>
      </div>
      <div class="grid-cell grid-cell-1-4">
        <div class="steps-mobile_item"
             (click)="stepper.current = (stepper.current === 3) ? 3 : stepper.current;"
             [ngClass]="{
                'active': addressForm.valid && conditionsForm.valid && !editableTokenProtector && previewTrigger && (stepper.current === 3),
                'checked': stepper.current > 3,
                'opened': stepper.current === 3
             }"></div>
      </div>
      <div class="grid-cell grid-cell-1-4">
        <div class="steps-mobile_item"
             (click)="stepper.current = (stepper.current === 4) ? 4 : stepper.current;"
             [ngClass]="{
                'active': addressForm.valid && conditionsForm.valid && !editableTokenProtector && previewTrigger && (stepper.current === 4),
                'checked': paymentForm.valid && (stepper.current > 4),
                'opened': stepper.current === 4
             }"></div>
      </div>
      <div class="grid-cell grid-cell-1-4">
        <div class="steps-mobile_item"
             (click)="stepper.current = (stepper.current === 5) ? 5 : stepper.current;"
             [ngClass]="{
                'active': addressForm.valid && conditionsForm.valid && !editableTokenProtector && previewTrigger && (stepper.current === 5),
                'checked': (stepper.current >= 5),
                'opened': stepper.current === 5
             }"></div>
      </div>

    </div>

    <!-- Main form -->
    <div class="container-contract">

      <div class="left-contract">
        <div class="form-container">

          <form class="form-block"
                #addressForm="ngForm"
                (submit)="nextStep(1)"
                [ngClass]="{
                    hidden: stepper.current !== 0,
                    checked: (addressForm.valid) && (stepper.current > 0),
                    'form-block__active': editableTokenProtector && (stepper.current === 0)
                }">
            <div class="form-block_title" (click)="stepper.current = (!previewTrigger && editableTokenProtector) ? 0 : stepper.current">The address for the protection</div>
            <div class="form-block_fieldset">
              <label class="form-field_label">Enter your address</label>
              <div class="form-field">
                <div class="form-field_input width-550-px">
                  <input type="text"
                    class="min-text max-placeholder"
                    maxlength="42"
                    pattern="0x[0-9a-fA-F]{40}"
                    required
                    [ngClass]="{'input_field-error': (reqData.contract_details.owner_address === reqData.contract_details.reserve_address)}"
                    [(ngModel)]="reqData.contract_details.owner_address"
                    placeholder="Ethereum address"
                    name="owner_address_1">
                </div>
                <div class="form-field_text normal-font width-550-px">
                  Your address which you want to protect from losing tokens (in case of losing private key/access). You will know private key of your address at the current moment.
                </div>
              </div>
              <label class="form-field_label">Enter reserve address</label>
              <div class="form-field">
                <div class="form-field_input width-550-px">
                    <input type="text"
                    class="min-text max-placeholder"
                    maxlength="42"
                    pattern="0x[0-9a-fA-F]{40}"
                    required
                    [ngClass]="{'input_field-error': (reqData.contract_details.owner_address === reqData.contract_details.reserve_address)}"
                    [(ngModel)]="reqData.contract_details.reserve_address"
                    placeholder="Ethereum address"
                    name="owner_address_2">
                </div>
                <div class="form-field_text normal-font width-550-px">
                  Reserve address which will get tokens from your address if conditions are met.
                </div>
              </div>
              <span *ngIf="reqData.contract_details.owner_address === reqData.contract_details.reserve_address" class="form-field error_text__address">use different addresses</span>
              <button class="button button-tp button-tp-blue is-medium" [disabled]="(reqData.contract_details.owner_address === reqData.contract_details.reserve_address) || !addressForm.valid || nextStepProcess" type="submit">
                <div class="lds-ellipsis" *ngIf="nextStepProcess">
                  <span class="lds-ellipsis-container">
                    <span></span><span></span><span></span><span></span>
                  </span>
                </div>
                <span *ngIf="!nextStepProcess" class="caption">Next step</span>
              </button>

            </div>
          </form>

          <div class="form-block"
               [ngClass]="{
                  hidden: !(addressForm.valid && (stepper.current === 1)),
                  'form-block__active': addressForm.valid && editableTokenProtector && (stepper.current === 1),
                  checked: conditionsForm.valid && (stepper.current > 1)
               }">
               
               <form #conditionsForm="ngForm" (submit)="nextStep(2)">

                <div class="form-block_title" (click)="stepper.current = (!previewTrigger && addressForm.valid && editableTokenProtector && (stepper.current >= 1)) ? 1 : stepper.current;">Conditions</div>
                
              <div class="form-block_fieldset">
                  <label class="form-field_label">Transfer the tokens from your address to Reserve address on</label>
                  <div class="form-field">
                    <div class="form-field_input width-550-px d-flex">
                      <input matInput [matDatepicker]="datepicker"
                        required
                        readonly
                        [min]="minDate"
                        [(ngModel)]="curDate"
                        (dateChange)="dateChange()"
                        name="active_to"
                        (click)="datepicker.open()" placeholder="Choose a date" class="min-text">
                      <mat-datepicker #datepicker></mat-datepicker>
                      <span class="mat-datepicker-toggle" (click)="datepicker.open()" >
                        <button mat-button mat-icon-button type="button">
                          <img src="./assets/images/icons/calendar.svg">
                        </button>
                      </span>
                    </div>
                    <div class="form-field_text normal-font">
                      You can cancel the Protection contract anytime before execution.
                    </div>
                  </div>
                
                  <div class="form-field">
                    <label class="form-field_label">Email for notifications (optional)</label>
                    <div class="form-field">
                      <div class="form-field_input width-550-px">
                        <input type="email"
                            class="min-text max-placeholder"
                            [email]="true"
                            [(ngModel)]="reqData.contract_details.email"
                            placeholder="Enter your email"
                            name="check_email">
                      </div>
                    </div>
                  </div>

                  <button class="button button-tp button-tp-blue is-medium" [disabled]="!conditionsForm.valid || nextStepProcess" type="submit">
                    <div class="lds-ellipsis" *ngIf="nextStepProcess">
                      <span class="lds-ellipsis-container">
                        <span></span><span></span><span></span><span></span>
                      </span>
                    </div>
                    <span *ngIf="!nextStepProcess" class="caption">Next step</span>
                  </button>

                </div>
              </form>
          </div>


          <div class="form-block"
               [ngClass]="{
                 hidden: !(addressForm.valid && conditionsForm.valid && (stepper.current === 2)),
                  'form-block__active': stepper.current === 2,
                  checked: stepper.current > 2
               }">
               
              <form #previewForm="ngForm" (submit)="nextStep(3)">
              
              <div class="form-block_title" (click)="stepper.current = (!previewTrigger && addressForm.valid && editableTokenProtector && (stepper.current >= 2)) ? 2 : stepper.current;">Preview</div>
              
              <div class="form-block_fieldset">

                <div class="form-field">
                  <label class="form-field_label">Your address</label>
                  <div class="form-field">
                    <div class="form-field_input width-550-px d-flex ai-center pr-50">
                      <input type="text"
                        class="min-text max-placeholder"
                        maxlength="42"
                        pattern="0x[0-9a-fA-F]{40}"
                        disabled
                        [(ngModel)]="reqData.contract_details.owner_address"
                        placeholder="Ethereum address"
                        name="check_owner_address_1">
                    </div>
                  </div>
                </div>

                <div class="form-field">
                  <label class="form-field_label">Reserve address</label>
                  <div class="form-field">
                    <div class="form-field_input width-550-px d-flex ai-center pr-50">
                      <input type="text"
                        class="min-text max-placeholder width-100"
                        maxlength="42"
                        pattern="0x[0-9a-fA-F]{40}"
                        disabled
                        [(ngModel)]="reqData.contract_details.reserve_address"
                        placeholder="Ethereum address"
                        name="check_reverse_address_2">
                    </div>
                  </div>
                </div>

                <div class="form-field">
                  <label class="form-field_label">Transfer the tokens from your address to Reserve address on</label>
                  <div class="form-field">
                    <div class="form-field_input width-550-px">
                      <input type="text"
                        [email]="true"
                        class="min-text max-placeholder"
                        disabled
                        [ngModel]="curDate|date"
                        (ngModelChange)="curDate=$event"
                        placeholder="Date"
                        name="check_date">
                    </div>
                  </div>
                </div>

                <div class="form-field">
                  <label class="form-field_label">Email Address mail for notifications</label>
                  <div class="form-field">
                    <div class="form-field_input width-550-px">
                      <input type="email"
                        [email]="true"
                        class="min-text max-placeholder"
                        disabled
                        [(ngModel)]="reqData.contract_details.email"
                        placeholder="Your email"
                        name="check_email">
                    </div>
                  </div>
                </div>

                <button class="button button-tp button-tp-blue is-medium" type="submit" [disabled]="nextStepProcess">
                  <div class="lds-ellipsis" *ngIf="nextStepProcess">
                    <span class="lds-ellipsis-container">
                      <span></span><span></span><span></span><span></span>
                    </span>
                  </div>
                  <span *ngIf="!nextStepProcess" class="caption">Next step</span>
                </button>

              </div>
            </form>
          </div>


          <div class="form-block"
               [ngClass]="{
                 hidden: !(previewTrigger && (stepper.current === 3)),
                  'form-block__active': addressForm.valid && conditionsForm.valid && !editableTokenProtector && previewTrigger && (stepper.current === 3),
                  checked: stepper.current > 3
               }">
            <div class="form-block_title" (click)="stepper.current = (stepper.current === 3) ? 3 : stepper.current;">Payment</div>
            <form class="form-block_fieldset" #paymentForm="ngForm" (submit)="nextStep(4)">
              <div class="form-field">
                
                <app-contract-form-pay
                  *ngIf="reqData.state === 'WAITING_FOR_PAYMENT'"
                  [contractCosts]="reqData.cost"
                  [costsEmitter]="costEmitter"
                  [currentUser]="currentUser">
                </app-contract-form-pay>

              </div>

            </form>
          </div>


          <div class="form-block"
               [ngClass]="{
                 hidden: !(paymentForm.valid && (stepper.current === 4)),
                  'form-block__active': addressForm.valid && conditionsForm.valid && !editableTokenProtector && previewTrigger && (stepper.current === 4),
                  checked: paymentForm.valid && (stepper.current > 4)
               }">
               
               <div class="form-block_title" (click)="stepper.current = (stepper.current === 4) ? 4 : stepper.current;">Deployment</div>
               
               <form class="form-block_fieldset" #deploymentForm="ngForm" (submit)="nextStep(5)">
                 
                <div class="form-field_deployment" *ngIf="reqData.state !== 'POSTPONED'">
                  <div class="ff_deployment-progress"></div>
                  <span class="ff_deployment-title">Contract Deployment is in progress...</span>
                  <span class="ff_deployment-text">It can take 10-15 minutes, please wait</span>
                </div>

                <div class="form-field_deployment" *ngIf="reqData.state === 'POSTPONED'">
                  <div class="ff_deployment-error"></div>
                  <span class="ff_deployment-title">Something went wrong</span>
                  <span class="ff_deployment-text">please try again later or contact us</span>
                </div>

            </form>
          </div>

          <div class="form-block" [ngClass]="{hidden: !(deploymentForm.valid && ( stepper.current === 5)), checked: (stepper.current >= 5),'form-block__active': (stepper.current === 5)}">
            <div class="form-block_title">Choose tokens for the protection</div>
            <div class="form-block_fieldset" *ngIf="!confirmStatus">
              <div class="form-block_text-token">
                You shall grant rights to the protection contract for transferring the tokens <br> if conditions are met.<br><br>
                Add every token which you need to protect:<br>
              </div>

              <div class="form-block_tokens__list">
                <div class="token_item" *ngFor="let token of tokens | FilterTokens:false:false:'':true">
                  <span [className]="'token_item__title token_item__icon-'+token.token_name"><span class="token_item__image" [ngStyle]="{'background-image':'url(' + token.image_link + ')'}"></span>({{ token.token_short_name }}) {{ token.token_name }}</span>
                  <span (click)="changeTokenStatus(token.address,false)" class="token_item__button token_item__button-active">APPROVED</span>
                </div>
              </div>

              <div class="form-field_line"></div>

              <div class="form-block_search-tokens">
                <input type="text"
                  class="min-text max-placeholder form-block_search-tokens_input"
                  #searchTokensInput
                  [(ngModel)]="searchToken"
                  placeholder="Search"
                  (input)="filterTokensLimit = 10">
                <span class="form-block_search-tokens_input-icon"></span>
                <span class="form-block_search-tokens_input-close" (click)="searchToken = ''"></span>
              </div>

              <div class="form-block_search-result" *ngIf="searchToken">
                <div class="form-block_tokens__list">

                  <ng-container *ngIf="searchToken">
                    <ng-container *ngFor="let token of tokens | FilterTokens:false:true:searchToken:false | slice:0:filterTokensLimit">
                      <ng-container *ngIf="(tokens.length <= 0 || tokens === null)">
                        <div class="token_item token_item__error">Tokens not found</div>
                      </ng-container>
                      <div class="token_item">
                        <span [className]="'token_item__title token_item__icon-'+token.token_name"><span class="token_item__image" [ngStyle]="{'background-image':'url(' + token.image_link + ')'}"></span>({{ token.token_short_name }}) {{ token.token_name }}</span>
                        <span class="token_item__button" [class.token_item__button_active]="token === selectedToken" (click)="changeTokenStatus(token.address);onSelect(token)">
                          <div class="lds-ellipsis">
                            <span class="lds-ellipsis-container">
                              <span></span><span></span><span></span><span></span>
                            </span>
                          </div>
                          APPROVE
                        </span>
                      </div>
                    </ng-container>
                    <div class="token_item token_item__more" (click)="loadMoreTokensFilter(tokens.length)" *ngIf="filterTokensLimit < tokens.length && filterTokensLimit !== tokens.length">Load more</div>
                  </ng-container>

                </div>
              </div>

              <app-transaction *ngIf="reqData.state === 'DEPLOYED'"></app-transaction>
              
              <div class="form-field_line"></div>

              <div class="form-block_subtitle">POPULAR</div>
              <div class="form-block_tokens__list">
                <div class="token_item" *ngFor="let token of tokens | FilterTokens:true:false:'':false">
                  <span [className]="'token_item__title token_item__icon-'+token.token_name"><span class="token_item__image" [ngStyle]="{'background-image':'url(' + token.image_link + ')'}"></span>({{ token.token_short_name }}) {{ token.token_name }}</span>
                  <span class="token_item__button" (click)="changeTokenStatus(token.address)">
                    <div class="lds-ellipsis">
                      <span class="lds-ellipsis-container">
                        <span></span><span></span><span></span><span></span>
                      </span>
                    </div>
                    APPROVE
                  </span>
                </div>
              </div>
              <div class="form-field_line"></div>

              <span *ngIf="confirmErrorMessage" class="form-field error_text__address">{{confirmErrorMessage || ''}}</span>

              <div class="form-field__button">
                <button (click)="nextStep(6)" class="button button-tp button-tp-blue is-medium" type="submit" [disabled]="nextStepProcess">
                  <div class="lds-ellipsis" *ngIf="nextStepProcess">
                    <span class="lds-ellipsis-container">
                      <span></span><span></span><span></span><span></span>
                    </span>
                  </div>
                  <span *ngIf="!nextStepProcess" class="caption">Next step</span>
                </button>
              </div>
            </div>
            <div class="form-field_deployment" *ngIf="confirmStatus">
              <div class="ff_deployment-progress"></div>
              <span class="ff_deployment-title">Waiting for confirm</span>
              <span class="ff_deployment-text">data sending to contract, please wait ...</span>
            </div>
          </div>
            
        </div>
      </div>
      
      <div class="right-contract">
        <div class="d-flex fd-column">
          <!-- <span class="button button-tp button-tp-watch is-medium">
            <span class="caption">Watch instruction</span>
          </span>
          <span class="button button-tp button-tp-support button-tp-icon-support is-medium">
            <span class="caption">Support</span>
          </span> -->
        </div>
      </div>

    </div>

  </div>
</div>


<ng-template #contactsReminderModal>
  <div class="dialog-block">
    <div class="dialog-block__content">
      <div class="info-modal-text">
        No contacting method has been selected.
        Please choose one of the contact methods.
        As our practice shows, if we can stay in touch with you, we can quicker find you a second participant for the trade.
      </div>
      <div class="contact-buttons"><br/><br/>
        <div class="grid-row">
          <div class="grid-cell grid-cell-ls-2-3 grid-cell-vs-1">
            <button class="btn btn-yellow btn-min text-center btn-auto ls-width-100" (click)="requestData.notification = true" mat-dialog-close>
              <span class="just-title">Add contact information</span>
            </button>
          </div>
          <div class="grid-cell grid-cell-1 show-ls">&nbsp;</div>
          <div class="grid-cell grid-cell-ls-2-3 grid-cell-vs-1">
            <button class="btn btn-transparent btn-min text-center btn-auto with-bg ls-width-100"
                    mat-dialog-close
                    (click)="gotToForm(100)">
              <span class="just-title">Skip this step</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>


<ng-template #ethSwapNotification>
  <div class="dialog-block">
    <div class="dialog-block__content">
      <div class="info-modal-text">
        Please note: That your pair can not be executed by smart contract. To make it decentralized please choose Ethereum based tokens.
      </div>
      <div class="contact-buttons"><br/><br/>
        <div class="grid-row">
          <div class="grid-cell grid-cell-ls-2-3 grid-cell-vs-1">
            <button class="btn btn-yellow btn-min text-center btn-auto ls-width-100"
                    mat-dialog-close>
              <span class="just-title">Change</span>
            </button>
          </div>
          <div class="grid-cell grid-cell-1 show-ls">&nbsp;</div>
          <div class="grid-cell grid-cell-ls-2-3 grid-cell-vs-1">
            <button class="btn btn-transparent btn-min text-center btn-auto with-bg ls-width-100"
                    mat-dialog-close
                    (click)="gotToForm(1)">
              <span class="just-title">Skip & continue</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>












